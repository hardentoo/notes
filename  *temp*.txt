Lemma foo : forall B a0 a m,
  {b : option B | lookup a0 (a :: m) = b}
    = if beq_nat a0 (fst a)
      then {b : option B | Some (snd a) = b }
      else {b : option B | lookup a0 m = b }.
Proof.
  intros.
  unfold lookup.
  destruct a. simpl.
  destruct (beq_nat a0 n); reflexivity.
Qed.

Definition lookup_total {B} : ∀ (m : list (nat * B)) a, In a (domain m) → 
  {b | lookup a m = b}.
Proof.
  induction m; simpl; intros.
    exists None.
    reflexivity.
  rewrite foo.
  destruct (beq_nat a0 (fst a)) eqn:Heqe.
    eexists.
    reflexivity.
  apply IHm.
  intuition.
  rewrite H0 in Heqe.
  rewrite <- beq_nat_refl in Heqe.
  discriminate.
Defined.